#!/usr/bin/env bash
set -euo pipefail
cd "$(dirname "$0")/.."

ENV_FILE=.env
[[ -f $ENV_FILE ]] || {
  echo "Creating .env from template…"; \
  cat > .env <<'EOF'
HOST_UID=$(id -u)
HOST_GID=$(id -g)
USERNAME=${USER}
DOCKER_DEFAULT_PLATFORM=linux/arm64
EOF
}

# Export only our custom env vars (avoid readonly builtins like UID)
export $(grep -E '^(HOST_UID|HOST_GID|USERNAME|DOCKER_DEFAULT_PLATFORM)=' .env | xargs)

compose() { docker compose "$@"; }

case "${1:-shell}" in
  build)
    compose build ;;
  up)
    docker volume inspect dev-workspace >/dev/null 2>&1 || docker volume create dev-workspace >/dev/null
    compose up -d ;;
  down|stop)
    compose down ;;
  exec)
    # exec into the existing singleton container if running
    CID=$(docker compose ps -q dev || true)
    if [[ -n "${CID}" ]] && [[ "$(docker inspect -f '{{.State.Running}}' "${CID}")" == "true" ]]; then
      docker exec -it "${CID}" bash
    else
      echo "No running dev container. Starting it…";
      docker volume inspect dev-workspace >/dev/null 2>&1 || docker volume create dev-workspace >/dev/null
      compose up -d
      CID=$(docker compose ps -q dev)
      docker exec -it "${CID}" bash
    fi ;;
  shell|sh|bash)
    # Back-compat alias for exec
    "$0" exec ;;
  amd64)
    # Start (if needed) with default platform; the daemon decides image arch on pull/build
    CID=$(docker compose ps -q dev || true)
    if [[ -z "${CID}" ]] || [[ "$(docker inspect -f '{{.State.Running}}' "${CID}" 2>/dev/null || echo false)" != "true" ]]; then
      docker volume inspect dev-workspace >/dev/null 2>&1 || docker volume create dev-workspace >/dev/null
      DOCKER_DEFAULT_PLATFORM=linux/amd64 compose up -d --build
      CID=$(docker compose ps -q dev)
    fi
    docker exec -it "${CID}" bash ;;
  ps)
    compose ps ;;
  logs)
    compose logs -f --tail=200 ;;
  volume-path)
    V=$(docker volume inspect dev-workspace -f '{{.Mountpoint}}' 2>/dev/null || true); \
    echo "dev-workspace mountpoint: ${V:-<unknown>}" ;;
  volume-create)
    docker volume create dev-workspace >/dev/null && echo "Created dev-workspace" || echo "dev-workspace already exists" ;;
  volume-rm)
    read -r -p "This will delete the dev-workspace volume. Continue? [y/N] " ans; \
    [[ "${ans:-N}" == "y" || "${ans:-N}" == "Y" ]] && docker volume rm -f dev-workspace || echo "Aborted" ;;
  *)
    compose "$@" ;;
esac