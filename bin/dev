#!/usr/bin/env bash
set -euo pipefail

here="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

usage() {
  cat <<'EOF'
Usage: bin/dev [up|down|shell|doctor|logs]

  up      Build & start devbox
  down    Stop devbox
  shell   Shell into devbox container
  doctor  Check SSH agent forwarding & GitHub access
  logs    Show container logs
EOF
}

svc="devbox"

cmd="${1:-}"
case "$cmd" in
  up)
    docker compose up -d --build
    ;;
  down)
    docker compose down
    ;;
  shell)
    docker compose exec "$svc" bash || docker compose run --rm "$svc" bash
    ;;
  logs)
    docker compose logs -f "$svc"
    ;;
  doctor)
    echo "==> Checking container is up..."
    docker compose up -d >/dev/null
    echo "==> SSH_AUTH_SOCK inside container:"
    docker compose exec "$svc" bash -lc 'echo "$SSH_AUTH_SOCK" && ls -l "$SSH_AUTH_SOCK"'
    echo "==> ssh-add -L (should list your host keys):"
    docker compose exec "$svc" bash -lc 'ssh-add -L || true'
    echo "==> GitHub reachability test (ssh -T git@github.com):"
    docker compose exec "$svc" bash -lc 'ssh -T git@github.com || true'
    echo "If you saw keys from ssh-add -L and a GitHub greeting, you are good."
    ;;
  ""|-h|--help|help)
    usage
    ;;
  *)
    echo "Unknown command: $cmd" >&2
    usage
    exit 2
    ;;
esac
